# 移动端控制功能 - 深度测试指南

## 📋 目录

1. [快速开始](#快速开始)
2. [手动测试步骤](#手动测试步骤)
3. [自动化测试](#自动化测试)
4. [问题排查](#问题排查)
5. [测试清单](#测试清单)

---

## 🚀 快速开始

### 步骤 1：启动服务器

打开两个终端窗口：

**终端 1 - 启动后端服务器**
```bash
cd d:/ftp/choujiang/log-lottery-main
node server.cjs
```

**终端 2 - 启动前端开发服务器**
```bash
cd d:/ftp/choujiang/log-lottery-main
npm run dev:fe
```

### 步骤 2：验证服务状态

- 后端：访问 http://localhost:3001/api/fonts
- 前端：访问 http://localhost:5173

如果两个页面都能正常访问，说明服务启动成功。

### 步骤 3：开始测试

选择以下任一测试方式：
- [手动测试](#手动测试步骤) - 适合完整功能验证
- [自动化测试](#自动化测试) - 适合快速验证

---

## 🔍 手动测试步骤

### 测试场景 1：基本功能验证

#### 1.1 大屏端准备

1. **访问大屏页面**
   - 打开浏览器访问：http://localhost:5173
   - 登录管理员账户（默认密码见 LOGIN_CONFIG.md）
   - 进入抽奖首页

2. **检查大屏状态**
   - ✓ 右上角应该显示锁图标（🔓）
   - ✓ 鼠标悬停在"开始抽奖"按钮上应该显示二维码
   - ✓ 二维码内容应该是 `http://localhost:5173/mobile-control`

3. **进入抽奖准备状态**
   - 点击"进入抽奖"按钮
   - 确认进入抽奖准备界面

#### 1.2 移动端登录

1. **访问移动端登录页**
   - 在同一网络的其他设备上访问：http://[你的IP]:5173/mobile-control
   - 或在同一电脑的新标签页打开

2. **登录验证**
   - 输入默认验证码：`123456`
   - 点击"登录"按钮
   - ✓ 应该显示"登录成功"提示
   - ✓ 自动跳转到控制面板

#### 1.3 移动端控制测试

1. **检查状态显示**
   - ✓ 应该显示"大屏状态"卡片
   - ✓ 状态指示灯应为绿色（可以控制）
   - ✓ 状态文本应为"可以控制"

2. **测试开始抽奖**
   - 点击"开始抽奖"按钮
   - ✓ 大屏应该开始抽奖
   - ✓ 移动端显示"开始抽奖"成功提示

3. **测试停止抽奖**
   - 点击"停止抽奖"按钮
   - ✓ 大屏应该停止抽奖
   - ✓ 移动端显示"停止抽奖"成功提示

### 测试场景 2：锁定功能测试

#### 2.1 大屏锁定

1. **锁定大屏**
   - 在大屏页面点击右上角的 🔓 图标
   - ✓ 图标应该变为 🔒（红色）
   - ✓ 显示"大屏已锁定"提示

2. **移动端验证**
   - 切换到移动端控制面板
   - ✓ 状态指示灯应变为红色
   - ✓ 状态文本应为"大屏已锁定"
   - ✓ "开始抽奖"和"停止抽奖"按钮应禁用

3. **尝试操作（应该失败）**
   - 点击"开始抽奖"按钮
   - ✓ 应该显示"大屏已锁定，无法操作"错误提示

#### 2.2 大屏解锁

1. **解锁大屏**
   - 在大屏页面点击右上角的 🔒 图标
   - ✓ 应该弹出解锁对话框
   - 输入管理员密码（与登录密码一致）
   - 点击"解锁"按钮
   - ✓ 应该显示"大屏已解锁"成功提示
   - ✓ 图标应变为 🔓（绿色）

2. **移动端验证**
   - 切换到移动端控制面板
   - ✓ 状态指示灯应变为绿色
   - ✓ 状态文本应为"可以控制"
   - ✓ 控制按钮应启用

### 测试场景 3：配置页面测试

#### 3.1 访问配置页面

1. **进入配置**
   - 在大屏页面点击"配置"
   - 导航到"全局配置" → "手机控制"

2. **查看配置界面**
   - ✓ 应该显示"总开关"卡片
   - ✓ 应该显示"验证码设置"卡片
   - ✓ 应该显示"连接状态"卡片
   - ✓ 应该显示"操作日志"卡片

#### 3.2 修改验证码

1. **更新验证码**
   - 点击"更新验证码"按钮
   - 输入新验证码（例如：`888888`）
   - 点击"确认更新"
   - 输入管理员密码
   - ✓ 应该显示"验证码更新成功"提示
   - ✓ 验证码显示为新验证码的掩码

2. **验证新验证码**
   - 在移动端登出并重新登录
   - 使用旧验证码登录
   - ✓ 应该显示"验证码错误"
   - 使用新验证码登录
   - ✓ 应该登录成功

#### 3.3 切换总开关

1. **关闭总开关**
   - 在配置页面关闭"启用手机控制功能"开关
   - 输入管理员密码确认
   - ✓ 应该显示"已关闭手机控制"提示

2. **验证功能关闭**
   - 在移动端访问登录页面
   - ✓ 应该显示"手机控制功能已关闭"错误
   - ✓ 自动跳转回首页

3. **重新开启总开关**
   - 在配置页面开启"启用手机控制功能"开关
   - 输入管理员密码确认
   - ✓ 应该显示"已开启手机控制"提示
   - 移动端应该可以正常登录

#### 3.4 查看操作日志

1. **查看日志**
   - 点击"查看日志"按钮
   - ✓ 应该显示操作日志列表
   - ✓ 日志应该包含时间戳、操作类型、设备信息

2. **清空日志**
   - 点击"清空日志"按钮
   - 输入管理员密码确认
   - ✓ 应该显示"日志已清空"提示
   - ✓ 日志列表应该为空

### 测试场景 4：WebSocket 连接测试

#### 4.1 连接稳定性

1. **打开浏览器开发者工具**
   - 按 F12 打开开发者工具
   - 切换到"Console"标签

2. **观察 WebSocket 消息**
   - 在大屏页面，应该看到类似日志：
     ```
     [MobileControl] WebSocket connected
     [MobileControl] WebSocket disconnected
     [MobileControl] Reconnecting...
     ```

3. **测试断线重连**
   - 关闭后端服务器（Ctrl+C）
   - 等待3秒
   - 重新启动后端服务器
   - ✓ 应该自动重连成功

#### 4.2 消息传递

1. **开始抽奖消息**
   - 移动端点击"开始抽奖"
   - 大屏控制台应该看到：
     ```
     [WebSocket] Received: { type: 'start_lottery' }
     ```

2. **停止抽奖消息**
   - 移动端点击"停止抽奖"
   - 大屏控制台应该看到：
     ```
     [WebSocket] Received: { type: 'stop_lottery' }
     ```

### 测试场景 5：单设备限制测试

#### 5.1 第一个设备连接

1. **设备A登录**
   - 使用浏览器A访问移动端登录页
   - 输入验证码登录
   - ✓ 登录成功

#### 5.2 第二个设备尝试连接

1. **设备B登录**
   - 使用浏览器B访问移动端登录页
   - 输入相同的验证码登录
   - ✓ 登录也应该成功（因为验证通过）

2. **设备B尝试控制**
   - 在设备B的控制面板点击"开始抽奖"
   - 如果设备A已连接并占用连接，设备B的控制可能会被拒绝
   - 日志中应该记录设备连接信息

#### 5.3 设备A断开连接

1. **设备A退出**
   - 在设备A的控制面板点击"退出登录"
   - 确认退出

2. **设备B验证**
   - 刷新设备B的控制面板
   - ✓ 应该可以正常控制（如果连接状态正确更新）

---

## 🤖 自动化测试

### 方法 1：HTML 测试工具

1. **打开测试页面**
   ```bash
   # 在浏览器中打开
   http://localhost:5173/test-mobile-control.html
   ```

2. **运行测试**
   - 点击"运行所有测试"按钮
   - 观察测试结果
   - 查看测试日志

3. **测试内容**
   - ✓ 获取总开关状态
   - ✓ 验证码验证
   - ✓ 获取大屏状态
   - ✓ WebSocket 连接
   - ✓ 获取操作日志
   - ✓ 开始/停止抽奖

### 方法 2：Node.js API 测试

1. **运行测试脚本**
   ```bash
   cd d:/ftp/choujiang/log-lottery-main
   node test-api.js
   ```

2. **查看结果**
   - ✓ 显示每个测试的结果
   - ✓ 统计通过率和失败数

### 方法 3：使用测试清单

1. **打开测试清单**
   ```
   TEST_CHECKLIST.md
   ```

2. **逐项测试**
   - 按照清单逐项测试
   - 勾选已完成的测试项
   - 记录问题和备注

---

## 🔧 问题排查

### 问题 1：无法连接到服务器

**症状**
- 浏览器显示"无法连接"
- API 请求失败

**解决方案**
1. 检查服务器是否运行：
   ```bash
   # 检查端口
   netstat -ano | findstr :3001
   netstat -ano | findstr :5173
   ```

2. 重新启动服务器：
   ```bash
   # 后端
   node server.cjs
   
   # 前端
   npm run dev:fe
   ```

3. 检查防火墙设置

### 问题 2：WebSocket 连接失败

**症状**
- 控制台显示"WebSocket connection failed"
- 无法接收移动端指令

**解决方案**
1. 检查 WebSocket 路径：`/ws/mobile-control`
2. 检查服务器日志
3. 尝试重新刷新页面
4. 检查浏览器控制台错误

### 问题 3：验证码验证失败

**症状**
- 输入正确的验证码仍显示"验证码错误"

**解决方案**
1. 确认验证码：默认为 `123456`
2. 检查是否修改过验证码
3. 查看配置页面确认当前验证码
4. 重启服务器（如果验证码缓存问题）

### 问题 4：管理员密码错误

**症状**
- 输入密码显示"管理员密码错误"

**解决方案**
1. 检查 `LOGIN_CONFIG.md` 文件
2. 确认密码格式正确
3. 尝试使用默认密码：`admin`

### 问题 5：移动端无法控制

**症状**
- 移动端按钮禁用
- 显示"无法操作"提示

**解决方案**
1. 确认大屏未锁定（图标为 🔓）
2. 确认大屏在抽奖页面（点击了"进入抽奖"）
3. 确认移动端控制功能已开启（配置页面）

### 问题 6：日志不显示

**症状**
- 操作日志为空
- 无法查看日志

**解决方案**
1. 检查日志文件是否存在：`logs/mobile-control.log`
2. 检查文件权限
3. 手动创建日志目录：
   ```bash
   mkdir logs
   ```

---

## ✅ 测试清单

### 基础功能测试
- [ ] 后端服务器启动正常
- [ ] 前端开发服务器启动正常
- [ ] 可以访问大屏页面
- [ ] 可以访问移动端登录页
- [ ] 可以访问配置页面

### 大屏端测试
- [ ] 锁图标显示正常
- [ ] 二维码显示正常
- [ ] 锁定/解锁功能正常
- [ ] WebSocket 连接正常

### 移动端测试
- [ ] 登录页面显示正常
- [ ] 验证码验证成功
- [ ] 控制面板显示正常
- [ ] 状态更新正常
- [ ] 开始/停止抽奖正常

### 配置页面测试
- [ ] 总开关切换正常
- [ ] 验证码更新正常
- [ ] 连接状态显示正常
- [ ] 操作日志显示正常

### 安全测试
- [ ] 管理员密码验证正常
- [ ] 单设备连接限制正常
- [ ] 状态验证正常

### 集成测试
- [ ] 正常使用流程
- [ ] 锁定状态
- [ ] 不在抽奖页面
- [ ] 功能关闭
- [ ] 网络断开重连

---

## 📝 测试记录

### 测试日期
- 开始时间：_________
- 结束时间：_________
- 测试人员：_________

### 测试结果
- 通过：_________
- 失败：_________
- 通过率：________%

### 发现的问题
1. __________________________
2. __________________________
3. __________________________

### 备注
__________________________
__________________________
__________________________

---

## 📞 技术支持

如有问题，请参考：
- 完整文档：`MOBILE_CONTROL_GUIDE.md`
- 测试清单：`TEST_CHECKLIST.md`
- 测试报告：`TEST_REPORT.md`

---

**祝测试顺利！** 🎉
